/*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
CODE TO GET AND MEASURE PAIRED OUTCOME RawScoreS AND RELIABLE CHANGE IN 
CYPMH, INCLUDING CONTEXTUAL MEASURES

DATA TO SUPPORT V2 OF CYP OUTCOMES DASHBOARDA 

CREATED BY TOM BARDSLEY 14 MAY 2021 
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>*/

--- DEFINE REPORTING PERIOD 

DECLARE @START_RP INT
DECLARE @END_RP INT
DECLARE @ReportingPeriodEnd DATETIME
DECLARE @ReportingPeriodStart DATETIME

SET @START_RP = 1417 --April 2018 (when we first start monitoring CYP outcomes)

SET @END_RP = (SELECT MAX(UniqMonthID) FROM NHSE_Sandbox_MentalHealth.dbo.PreProc_Header) --WHERE Der_MostRecentFlag = 'Y')

SET @ReportingPeriodStart = (SELECT MAX(ReportingPeriodStartDate)
FROM NHSE_Sandbox_MentalHealth.dbo.PreProc_Header
WHERE UniqMonthID = @START_RP)

SET @ReportingPeriodEnd = (SELECT MAX(ReportingPeriodEndDate)
FROM NHSE_Sandbox_MentalHealth.dbo.PreProc_Header
WHERE UniqMonthID = @END_RP)



/*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
GET DISCHARGED REFERRALS FOR CYP IN THE REPORTING PERIOD 
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>*/

IF OBJECT_ID ('tempdb..#ClosedRefs') IS NOT NULL
DROP TABLE #ClosedRefs

SELECT 
	r.Person_ID
	,r.UniqServReqID
	,r.RecordNumber
	,r.ServTeamTypeRefToMH
	,CASE 
		WHEN r.ServTeamTypeRefToMH IN ('A02','A03','A04','A11','A18','A19','A20','A21','A23','A24','C05') THEN 'Crisis & Liaison' 
		WHEN r.ServTeamTypeRefToMH IN ('B01','B02') THEN 'Forensic' 
		WHEN r.ServTeamTypeRefToMH IN ('A01','A05','A06','A07','A08','A09','A12','A13','A14','A15','A16','A17','A10') THEN 'General MH  services' 
		WHEN r.ServTeamTypeRefToMH IN ('C01','C04','E01','E02','E03','E04') THEN 'LDA' 
		WHEN r.ServTeamTypeRefToMH IN ('Z01','Z02') THEN 'Other' 
		WHEN r.ServTeamTypeRefToMH IN ('C02','C03','C06','C07','C08','C09','C10','D01','D02','D03','D04','D05','D06','D07','D08') THEN 'Specialist MH services' 
		ELSE 'Invalid/missing' 
	END as TeamTypeCat
	,r.Der_FY
	,r.UniqMonthID
	,h.ReportingPeriodStartDate
	,r.OrgIDProv AS Provider_Code 
	,COALESCE(o1.Organisation_Name,'Missing/Invalid') AS Provider_Name
	,o1.ODS_Organisation_Type
	,CASE 
		WHEN o1.ODS_Organisation_Type = 'NHS TRUST' THEN 'NHS'
		WHEN o1.ODS_Organisation_Type = 'CARE TRUST' THEN 'NHS' 
		WHEN o1.ODS_Organisation_Type IN ('LOCAL AUTHORITY','LOCAL AUTHORITY SITE') THEN 'LOCAL AUTHORITY' 
		WHEN o1.ODS_Organisation_Type IN ('INDEPENDENT SECTOR HEALTHCARE PROVIDER','INDEPENDENT SECTOR H/C PROVIDER SITE','NON-NHS ORGANISATION') THEN 'NON-NHS' 
		ELSE 'Missing/Invalid' 
	END as Provider_Type
	,COALESCE(o2.Region_Code,'Missing/Invalid') AS Region_Code --- regions taken from CCG of provider rather than CCG of residence
	,COALESCE(o2.Region_Name,'Missing/Invalid') AS Region_Name
	,COALESCE(o1.Region_Code,'Missing/Invalid') AS Region_Code_prov 
	,COALESCE(o1.Region_Name,'Missing/Invalid') AS Region_Name_prov
	,COALESCE(o1.STP_Code,'Missing/Invalid') AS STP_Code_prov
	,COALESCE(o1.STP_Name,'Missing/Invalid') AS STP_Name_prov
	,COALESCE(cc.New_Code,r.OrgIDCCGRes,'Missing/Invalid') AS CCGCode
	,COALESCE(o2.Organisation_Name,'Missing/Invalid') AS CCG_Name
	,COALESCE(o2.STP_Code,'Missing/Invalid') AS STP_Code
	,COALESCE(o2.STP_Name,'Missing/Invalid') AS STP_Name
	,r.AgeServReferRecDate
	,CASE WHEN r.Gender = '1' THEN 'M' WHEN r.Gender = '2' THEN 'F' ELSE NULL END as Gender
	,r.ReferralRequestReceivedDate
	,r.ServDischDate
	,r.ReferClosReason
	,DATEDIFF(DD, r.ReferralRequestReceivedDate, r.ServDischDate)+1 AS RefLength
	,CASE WHEN (DATEDIFF(DD, r.ReferralRequestReceivedDate, r.ServDischDate)+1) >= 7 THEN 1 ELSE 0 END as AtLeast7days
	,ROW_NUMBER()OVER(PARTITION BY r.UniqServReqID ORDER BY r.RecordNumber desc) AS RN

INTO #ClosedRefs

FROM NHSE_Sandbox_MentalHealth.dbo.PreProc_Referral r 

LEFT JOIN 
	(SELECT i.Person_ID, i.UniqServReqID, COUNT(i.Der_HospSpellRecordOrder) AS Der_HospSpellCount
	FROM [NHSE_Sandbox_MentalHealth].[dbo].[PreProc_Inpatients] i
	GROUP BY i.Person_ID, i.UniqServReqID) i ON i.Person_ID = r.Person_ID AND i.UniqServReqID = r.UniqServReqID -- to indentify referrals to inpatient services

LEFT JOIN (SELECT DISTINCT UniqMonthID, ReportingPeriodStartDate FROM NHSE_Sandbox_MentalHealth.dbo.PreProc_Header) h ON r.UniqMonthID = h.UniqMonthID

LEFT JOIN NHSE_Reference.dbo.tbl_Ref_ODS_Provider_Hierarchies o1 ON r.OrgIDProv = o1.Organisation_Code --- providers 
LEFT JOIN NHSE_Reference.dbo.tbl_Ref_Other_ComCodeChanges cc ON r.OrgIDCCGRes = cc.Org_Code 
LEFT JOIN NHSE_Reference.dbo.tbl_Ref_ODS_Commissioner_Hierarchies o2 ON COALESCE(cc.New_Code,r.OrgIDCCGRes) = o2.Organisation_Code --- CCG / STP / Region 

WHERE r.AgeServReferRecDate BETWEEN 0 AND 17 --- changed from 0-18 to match CQUIN 
AND r.UniqMonthID BETWEEN @START_RP AND @END_RP 
AND r.ReferralRequestReceivedDate >= '2016-01-01' 
AND r.ReferRejectionDate IS NULL 
AND r.ServDischDate IS NOT NULL --- discharged referrals only, not counting inactive referrals 
AND i.Der_HospSpellCount IS NULL --- to exclude referrals with an associated hospital spell 
AND (r.LADistrictAuth LIKE 'E%' OR r.LADistrictAuth IS NULL) -- to limit to those people whose commissioner is an English organisation 



/*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
GET CONTACTS FOR CLOSED CYP REFERRALS 
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>*/

IF OBJECT_ID ('tempdb..#Contacts') IS NOT NULL
DROP TABLE #Contacts

SELECT 
	r.Person_ID
	,r.UniqServReqID
	,r.RecordNumber 
	,r.Provider_Code
	,COUNT(*) AS TotalContacts 
	,SUM(CASE WHEN a.AttendOrDNACode IN ('5','6') THEN 1 ELSE 0 END) as AttendedContacts 
	,MAX(CASE WHEN a.Der_ContactOrder = 1 THEN a.Der_ContactDate ELSE NULL END) AS Contact1 
	,MAX(CASE WHEN a.Der_ContactOrder = 2 THEN a.Der_ContactDate ELSE NULL END) AS Contact2 

INTO #Contacts

FROM #ClosedRefs r 

INNER JOIN NHSE_Sandbox_MentalHealth.dbo.PreProc_Activity a ON r.Person_ID = a.Person_ID AND a.UniqServReqID = r.UniqServReqID 

WHERE r.RN = 1 

GROUP BY r.Person_ID, r.UniqServReqID, r.RecordNumber, r.Provider_Code 



/*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
GET ALL RELEVANT ASSESSMENTS USED FOR MEASURING CYP OUTCOMES 
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>*/

IF OBJECT_ID ('tempdb..#get_ass') IS NOT NULL
DROP TABLE #get_ass

SELECT 
	r.Person_ID
	,r.UniqServReqID
	,r.RecordNumber
	,r.Provider_Code
	,a.Der_AssUniqID
	,a.Der_AssTable
	,a.Der_AssToolCompDate
	,a.CodedAssToolType
	,a.Der_PreferredTermSNOMED
	,a.Der_AssessmentToolName
	,a.Der_AssessmentCategory
	,a.PersScore
	,a.Der_ValidScore
	--,a.Der_UniqAssessment
	,CASE 
		WHEN a.Der_PreferredTermSNOMED IN 
			('Childrens global assessment scale score'
			,'HoNOSCA-CR (Health of the Nation Outcome Scales for Children and Adolescents - clinician-rated) scale 1 score - disruptive, antisocial or aggressive behaviour'
			,'HoNOSCA-CR (Health of the Nation Outcome Scales for Children and Adolescents - clinician-rated) scale 10 score - peer relationships'
			,'HoNOSCA-CR (Health of the Nation Outcome Scales for Children and Adolescents - clinician-rated) scale 11 score - self care and independence'
			,'HoNOSCA-CR (Health of the Nation Outcome Scales for Children and Adolescents - clinician-rated) scale 12 score - family life and relationships'
			,'HoNOSCA-CR (Health of the Nation Outcome Scales for Children and Adolescents - clinician-rated) scale 13 score - poor school attendance'
			,'HoNOSCA-CR (Health of the Nation Outcome Scales for Children and Adolescents - clinician-rated) scale 2 score - overactivity, attention and concentration'
			,'HoNOSCA-CR (Health of the Nation Outcome Scales for Children and Adolescents - clinician-rated) scale 3 score - non-accidental self injury'
			,'HoNOSCA-CR (Health of the Nation Outcome Scales for Children and Adolescents - clinician-rated) scale 4 score - alcohol, substance/solvent misuse'
			,'HoNOSCA-CR (Health of the Nation Outcome Scales for Children and Adolescents - clinician-rated) scale 5 score - scholastic or language skills'
			,'HoNOSCA-CR (Health of the Nation Outcome Scales for Children and Adolescents - clinician-rated) scale 6 score - physical illness or disability problems'
			,'HoNOSCA-CR (Health of the Nation Outcome Scales for Children and Adolescents - clinician-rated) scale 7 score - hallucinations and delusions'
			,'HoNOSCA-CR (Health of the Nation Outcome Scales for Children and Adolescents - clinician-rated) scale 8 score - non-organic somatic symptoms'
			,'HoNOSCA-CR (Health of the Nation Outcome Scales for Children and Adolescents - clinician-rated) scale 9 score - emotional and related symptoms'
			) THEN 'Clinician' 
		WHEN a.Der_PreferredTermSNOMED IN 
			('HoNOSCA-SR (Health of the Nation Outcome Scales for Children and Adolescents - self-rated) scale 10 score - peer relationships'
			,'HoNOSCA-SR (Health of the Nation Outcome Scales for Children and Adolescents - self-rated) scale 11 score - self care and independence'
			,'HoNOSCA-SR (Health of the Nation Outcome Scales for Children and Adolescents - self-rated) scale 12 score - family life and relationships'
			,'HoNOSCA-SR (Health of the Nation Outcome Scales for Children and Adolescents - self-rated) scale 13 score - poor school attendance'
			,'HoNOSCA-SR (Health of the Nation Outcome Scales for Children and Adolescents - self-rated) scale 2 score - overactivity, attention and concentration'
			,'HoNOSCA-SR (Health of the Nation Outcome Scales for Children and Adolescents - self-rated) scale 3 score - non-accidental self injury'
			,'HoNOSCA-SR (Health of the Nation Outcome Scales for Children and Adolescents - self-rated) scale 4 score - alcohol, substance/solvent misuse'
			,'HoNOSCA-SR (Health of the Nation Outcome Scales for Children and Adolescents - self-rated) scale 5 score - scholastic or language skills'
			,'HoNOSCA-SR (Health of the Nation Outcome Scales for Children and Adolescents - self-rated) scale 6 score - physical illness or disability problems'
			,'HoNOSCA-SR (Health of the Nation Outcome Scales for Children and Adolescents - self-rated) scale 7 score - hallucinations and delusions'
			,'HoNOSCA-SR (Health of the Nation Outcome Scales for Children and Adolescents - self-rated) scale 8 score - non-organic somatic symptoms'
			,'HoNOSCA-SR (Health of the Nation Outcome Scales for Children and Adolescents - self-rated) scale 9 score - emotional and related symptoms'
			,'Child Outcome Rating Scale total score'
			,'Clinical Outcomes in Routine Evaluation - 10 clinical score'
			,'Generalized anxiety disorder 7 item score'
			,'Goal Progress Chart - Child/Young Person - goal 1 score'
			,'Goal Progress Chart - Child/Young Person - goal 2 score'
			,'Goal Progress Chart - Child/Young Person - goal 3 score'
			,'Goal Progress Chart - Child/Young Person - goal score'
			,'Outcome Rating Scale total score'
			,'Patient health questionnaire 9 score'
			,'RCADS (Revised Childrens Anxiety and Depression Scale) - Depression score'
			,'RCADS (Revised Childrens Anxiety and Depression Scale) - Generalized Anxiety score'
			,'RCADS (Revised Childrens Anxiety and Depression Scale) - Obsessions/Compulsions score'
			,'RCADS (Revised Childrens Anxiety and Depression Scale) - Panic score'
			,'RCADS (Revised Childrens Anxiety and Depression Scale) - Separation Anxiety score'
			,'RCADS (Revised Childrens Anxiety and Depression Scale) - Social Phobia score'
			,'SCORE Index of Family Function and Change - 15 - total score'
			,'Short Warwick-Edinburgh Mental Well-being Scale score'
			,'SDQ (Strengths and Difficulties Questionnaire) self-rated for 11-17 year olds - conduct problems score'
			,'SDQ (Strengths and Difficulties Questionnaire) self-rated for 11-17 year olds - emotional symptoms score'
			,'SDQ (Strengths and Difficulties Questionnaire) self-rated for 11-17 year olds - hyperactivity score'
			,'SDQ (Strengths and Difficulties Questionnaire) self-rated for 11-17 year olds - impact score'
			,'SDQ (Strengths and Difficulties Questionnaire) self-rated for 11-17 year olds - peer problems score'
			,'SDQ (Strengths and Difficulties Questionnaire) self-rated for 11-17 year olds - prosocial score'
			,'Warwick-Edinburgh Mental Well-being Scale score'
			,'Young Person''s Clinical Outcomes in Routine Evaluation clinical score') THEN 'Self' 
		ELSE 'Parent' 
		END as Rater 
					
INTO #get_ass 

FROM #ClosedRefs r 

INNER JOIN NHSE_Sandbox_MentalHealth.dbo.PreProc_Assessments a ON r.UniqServReqID = a.UniqServReqID AND r.Person_ID = a.Person_ID

WHERE a.Der_AssessmentToolName IN 
	('Childrens Global Assessment Scale (CGAS)'
	,'HoNOS-CA (Child and Adolescent)' --- only including HONOSCA, not adult HONOS. Many need to include LD HONOS if that's is relevant to CYP 
	,'Child Outcome Rating Scale (CORS)'
	,'Clinical Outcomes in Routine Evaluation 10 (CORE 10)'
	--,'CORE-OM (Clinical Outcomes in Routine Evaluation - Outcome Measure) ' -- check psychometric properties / if it's being used with CYP 
	,'Genralised Anxiety Disorder 7 (GAD-7)'
	,'Goal Based Outcomes (GBO)'
	,'Outcome Rating Scale (ORS)'
	,'Patient Health Questionnaire (PHQ-9)'
	,'Short Warwick-Edinburgh Mental Well-being Scale (SWEMWBS)'
	,'Warwick-Edinburgh Mental Well-being Scale (WEMWBS)'
	,'YP-CORE'
	)

OR a.Der_PreferredTermSNOMED IN 
	('SDQ (Strengths and Difficulties Questionnaire) for parents or educators of 4-17 year olds - conduct problems - parent score'
	,'SDQ (Strengths and Difficulties Questionnaire) for parents or educators of 4-17 year olds - emotional symptoms - parent score'
	,'SDQ (Strengths and Difficulties Questionnaire) for parents or educators of 4-17 year olds - hyperactivity - parent score'
	,'SDQ (Strengths and Difficulties Questionnaire) for parents or educators of 4-17 year olds - impact - parent score'
	,'SDQ (Strengths and Difficulties Questionnaire) for parents or educators of 4-17 year olds - peer problems - parent score'
	,'SDQ (Strengths and Difficulties Questionnaire) for parents or educators of 4-17 year olds - prosocial - parent score'
	,'SDQ (Strengths and Difficulties Questionnaire) self-rated for 11-17 year olds - conduct problems score'
	,'SDQ (Strengths and Difficulties Questionnaire) self-rated for 11-17 year olds - emotional symptoms score'
	,'SDQ (Strengths and Difficulties Questionnaire) self-rated for 11-17 year olds - hyperactivity score'
	,'SDQ (Strengths and Difficulties Questionnaire) self-rated for 11-17 year olds - impact score'
	,'SDQ (Strengths and Difficulties Questionnaire) self-rated for 11-17 year olds - peer problems score'
	,'SDQ (Strengths and Difficulties Questionnaire) self-rated for 11-17 year olds - prosocial score'
	,'RCADS (Revised Childrens Anxiety and Depression Scale) - Depression score'
	,'RCADS (Revised Childrens Anxiety and Depression Scale) - Generalized Anxiety score'
	,'RCADS (Revised Childrens Anxiety and Depression Scale) - Obsessions/Compulsions score'
	,'RCADS (Revised Childrens Anxiety and Depression Scale) - Panic score'
	,'RCADS (Revised Childrens Anxiety and Depression Scale) - Separation Anxiety score'
	,'RCADS (Revised Childrens Anxiety and Depression Scale) - Social Phobia score'
	,'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Depression score'
	,'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Generalized Anxiety score'
	,'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Obsessions/Compulsions score'
	,'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Panic score'
	,'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Separation Anxiety score'
	,'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Social Phobia score'
	,'SCORE Index of Family Function and Change - 15 - total score'
	)

AND ISNUMERIC(a.PersScore) = 1 
AND r.RN = 1 


/*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
BRING REFERRALS, CONTACTS AND OUTCOMES TOGETHER 
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>*/

IF OBJECT_ID ('tempdb..#RefAss') IS NOT NULL
DROP TABLE #RefAss

SELECT 
	r.Person_ID
	,r.UniqServReqID
	,r.RecordNumber
	,r.ServTeamTypeRefToMH
	,r.TeamTypeCat
	,r.Der_FY
	,r.UniqMonthID
	,r.ReportingPeriodStartDate
	,r.Provider_Code 
	,r.Provider_Name
	,r.Provider_Type
	,r.Region_Code --- regions taken from CCG of provider rather than CCG of residence
	,r.Region_Name
	,r.CCGCode
	,r.CCG_Name
	,r.STP_Code
	,r.STP_Name
	,r.STP_Code_prov
	,r.STP_Name_prov
	,r.Region_Code_prov
	,r.Region_Name_prov
	,r.AgeServReferRecDate AS Age
	,r.Gender
	,r.ReferralRequestReceivedDate
	,r.ServDischDate
	,r.ReferClosReason
	,r.RefLength
	,r.AtLeast7days
	,c.TotalContacts
	,c.AttendedContacts
	,c.Contact1
	,c.Contact2
	,a.Der_AssUniqID
	,a.Der_AssTable
	,a.Der_AssToolCompDate
	,DATEADD(MONTH, DATEDIFF(MONTH, 0, Der_AssToolCompDate), 0) AS Ass_MonthYear
	,a.CodedAssToolType
	,a.Der_PreferredTermSNOMED AS AssName
	,a.Der_AssessmentToolName AS AssType 
	,a.Rater
	,a.Der_AssessmentCategory
	,CAST(a.PersScore AS NUMERIC(19,4)) AS RawScore
	--,a.PersScore AS RawScore
	,a.Der_ValidScore
	--,a.Der_UniqAssessment

INTO #RefAss

FROM #ClosedRefs r 

LEFT JOIN #Contacts c ON r.Person_ID = c.Person_ID AND r.UniqServReqID = c.UniqServReqID

LEFT JOIN #get_ass a ON r.Person_ID = a.Person_ID AND r.UniqServReqID = a.UniqServReqID 

WHERE PersScore <> 'N' AND PersScore <> 'OK' --- remove pesky non-numeric scores 
AND r.RN = 1 





--- transform RCADS RawScores, assign clinical cutoff point and remove invalid scores 
IF OBJECT_ID ('tempdb..#transform') IS NOT NULL
DROP TABLE #transform

SELECT *,
	CASE 
	WHEN	(Gender	=	'M'	AND	Age	IN ('8','9')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Depression Score')	THEN	((RawScore	 - 8.25 )*10)/ 4.09 + 50
	WHEN	(Gender	=	'M'	AND	Age	IN ('8','9')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Generalized Anxiety Score')	THEN	((RawScore	 - 6.98 )*10)/ 3.36 + 50
	WHEN	Gender	=	'M'	AND	Age	IN ('8','9')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Obsessions/Compulsions Score'	THEN	((RawScore	 - 6.15)*10)/ 3.2+ 50
	WHEN	Gender	=	'M'	AND	Age	IN ('8','9')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Panic Score'	THEN	((RawScore	- 5.25)*10)/ 4.15+ 50
	WHEN	Gender	=	'M'	AND	Age	IN ('8','9')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Separation Anxiety Score'	THEN	((RawScore	- 4.87)*10)/ 3.93 + 50
	WHEN	Gender	=	'M'	AND	Age	IN ('8','9')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Social Phobia Score'	THEN	((RawScore	- 9.77)*10)/ 4.51 + 50
	WHEN	Gender	=	'F'	AND	Age	IN ('8','9')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Depression Score'	THEN	((RawScore	- 8.74)*10)/ 4.75+ 50
	WHEN	Gender	=	'F'	AND	Age	IN ('8','9')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Generalized Anxiety Score'	THEN	((RawScore	- 7.77)*10)/ 3.77+ 50
	WHEN	Gender	=	'F'	AND	Age	IN ('8','9')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Obsessions/Compulsions Score'	THEN	((RawScore	- 7.62)*10)/ 3.68+ 50
	WHEN	Gender	=	'F'	AND	Age	IN ('8','9')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Panic Score'	THEN	((RawScore	- 6.51)*10)/ 4.73 + 50
	WHEN	Gender	=	'F'	AND	Age IN ('8','9')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Separation Anxiety Score'	THEN	((RawScore	- 7.05)*10)/ 4.31+ 50
	WHEN	Gender	=	'F'	AND	Age	IN ('8','9')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Social Phobia Score'	THEN	((RawScore	- 11.61)*10)/ 4.98+ 50
	WHEN	Gender	=	'M'	AND	Age	IN	('10','11')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Depression Score'	THEN	((RawScore	- 7.07) *10)/ 3.64+ 50
	WHEN	Gender	=	'M'	AND	Age	IN	('10','11')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Generalized Anxiety Score'	THEN	((RawScore	- 6.44) *10)/ 3.13 + 50
	WHEN	Gender	=	'M'	AND	Age	IN	('10','11')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Obsessions/Compulsions Score'	THEN	((RawScore	- 6.01) *10)/ 3.26 + 50
	WHEN	Gender	=	'M'	AND	Age	IN	('10','11')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Panic Score'	THEN	((RawScore	- 4.06) *10)/ 3.6+ 50
	WHEN	Gender	=	'M'	AND	Age	IN	('10','11')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Separation Anxiety Score'	THEN	((RawScore	- 3.2) *10)/ 3.05+ 50
	WHEN	Gender	=	'M'	AND	Age	IN	('10','11')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Social Phobia Score'	THEN	((RawScore	- 10.30 )*10)/ 4.75+ 50
	WHEN	Gender	=	'F'	AND	Age	IN	('10','11')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Depression Score'	THEN	((RawScore	- 7.64)*10)/  4.1+ 50
	WHEN	Gender	=	'F'	AND	Age	IN	('10','11')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Generalized Anxiety Score'	THEN	((RawScore	- 8.01)*10)/ 3.68 + 50
	WHEN	Gender	=	'F'	AND	Age	IN	('10','11')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Obsessions/Compulsions Score'	THEN	((RawScore	- 6.39)*10)/ 3.46+ 50
	WHEN	Gender	=	'F'	AND	Age	IN	('10','11')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Panic Score'	THEN	((RawScore	-   5.25 )*10)/ 4.3 + 50
	WHEN	Gender	=	'F'	AND	Age	IN	('10','11')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Separation Anxiety Score'	THEN	((RawScore	- 4.74)*10)/ 3.78+ 50
	WHEN	Gender	=	'F'	AND	Age	IN	('10','11')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Social Phobia Score'	THEN	((RawScore	- 12.92)*10)/ 5.21 + 50
	WHEN	Gender	=	'M'	AND	Age	IN	('12','13')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Depression Score'	THEN	((RawScore	- 6.71) *10)/ 3.64+ 50
	WHEN	Gender	=	'M'	AND	Age	IN	('12','13')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Generalized Anxiety Score'	THEN	((RawScore	- 6.2) *10)/  3.14+ 50
	WHEN	Gender	=	'M'	AND	Age	IN	('12','13')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Obsessions/Compulsions Score'	THEN	((RawScore	- 5.22 ) *10)/  3.40 + 50
	WHEN	Gender	=	'M'	AND	Age	IN	('12','13')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Panic Score'	THEN	((RawScore	- 3.62  ) *10)/  3.36 + 50
	WHEN	Gender	=	'M'	AND	Age	IN	('12','13')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Separation Anxiety Score'	THEN	((RawScore	- 2.26) *10)/  2.47+ 50
	WHEN	Gender	=	'M'	AND	Age	IN	('12','13')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Social Phobia Score'	THEN	((RawScore	- 11.05 )*10)/  4.74  + 50
	WHEN	Gender	=	'F'	AND	Age	IN	('12','13')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Depression Score'	THEN	((RawScore	- 7.89)*10)/ 3.91 + 50
	WHEN	Gender	=	'F'	AND	Age	IN	('12','13')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Generalized Anxiety Score'	THEN	((RawScore	- 7.42)*10)/  3.16+ 50
	WHEN	Gender	=	'F'	AND	Age	IN	('12','13')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Obsessions/Compulsions Score'	THEN	((RawScore	- 5.12)*10)/  3.34 + 50
	WHEN	Gender	=	'F'	AND	Age	IN	('12','13')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Panic Score'	THEN	((RawScore	-  5.03  )*10)/  3.92 + 50
	WHEN	Gender	=	'F'	AND	Age	IN	('12','13')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Separation Anxiety Score'	THEN	((RawScore	- 3.00  )*10)/  2.72+ 50
	WHEN	Gender	=	'F'	AND	Age	IN	('12','13')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Social Phobia Score'	THEN	((RawScore	- 13.01 )*10)/  4.94 + 50
	WHEN	Gender	=	'M'	AND	Age	IN	('14','15')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Depression Score'	THEN	((RawScore	- 7.44) *10)/ 4.1+ 50
	WHEN	Gender	=	'M'	AND	Age	IN	('14','15')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Generalized Anxiety Score'	THEN	((RawScore	- 7.07) *10)/  2.93+ 50
	WHEN	Gender	=	'M'	AND	Age	IN	('14','15')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Obsessions/Compulsions Score'	THEN	((RawScore	- 4.65) *10)/  2.89+ 50
	WHEN	Gender	=	'M'	AND	Age	IN	('14','15')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Panic Score'	THEN	((RawScore	- 3.76) *10)/  3.21+ 50
	WHEN	Gender	=	'M'	AND	Age	IN	('14','15')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Separation Anxiety Score'	THEN	((RawScore	- 2.5) *10)/  2.46+ 50
	WHEN	Gender	=	'M'	AND	Age	IN	('14','15')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Social Phobia Score'	THEN	((RawScore	- 11.68)*10)/  4.74+ 50
	WHEN	Gender	=	'F'	AND	Age	IN	('14','15')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Depression Score'	THEN	((RawScore	- 7.65)*10)/ 3.68+ 50
	WHEN	Gender	=	'F'	AND	Age	IN	('14','15')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Generalized Anxiety Score'	THEN	((RawScore	- 7.28)*10)/  3.44+ 50
	WHEN	Gender	=	'F'	AND	Age	IN	('14','15')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Obsessions/Compulsions Score'	THEN	((RawScore	- 4.12  )*10)/  2.79 + 50
	WHEN	Gender	=	'F'	AND	Age	IN	('14','15')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Panic Score'	THEN	((RawScore	-  4.18)*10)/  3.07+ 50
	WHEN	Gender	=	'F'	AND	Age	IN	('14','15')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Separation Anxiety Score'	THEN	((RawScore	- 2.34)*10)/  2.23+ 50
	WHEN	Gender	=	'F'	AND	Age	IN	('14','15')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Social Phobia Score'	THEN	((RawScore	- 12.27)*10)/ 5.00   + 50
	WHEN	Gender	=	'M'	AND	Age	IN	('16','17')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Depression Score'	THEN	((RawScore	- 7.32) *10)/ 3.81+ 50
	WHEN	Gender	=	'M'	AND	Age	IN	('16','17')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Generalized Anxiety Score'	THEN	((RawScore	- 6.76) *10)/  3.44+ 50
	WHEN	Gender	=	'M'	AND	Age	IN	('16','17')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Obsessions/Compulsions Score'	THEN	((RawScore	- 5.18) *10)/ 3.12+ 50
	WHEN	Gender	=	'M'	AND	Age	IN	('16','17')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Panic Score'	THEN	((RawScore	- 3.79) *10)/  2.71+ 50
	WHEN	Gender	=	'M'	AND	Age	IN	('16','17')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Separation Anxiety Score'	THEN	((RawScore	- 1.9) *10)/ 2.03+ 50
	WHEN	Gender	=	'M'	AND	Age	IN	('16','17')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Social Phobia Score'	THEN	((RawScore	- 10.67)*10)/ 4.49+ 50
	WHEN	Gender	=	'F'	AND	Age	IN	('16','17')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Depression RawScore'	THEN	((RawScore	- 9.36)*10)/ 4.45+ 50
	WHEN	Gender	=	'F'	AND	Age	IN	('16','17')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Generalized Anxiety Score'	THEN	((RawScore	- 8.49)*10)/ 3.71+ 50
	WHEN	Gender	=	'F'	AND	Age	IN	('16','17')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Obsessions/Compulsions Score'	THEN	((RawScore	- 5.48)*10)/ 3.82+ 50
	WHEN	Gender	=	'F'	AND	Age	IN	('16','17')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Panic Score'	THEN	((RawScore	- 5.26)*10)/ 4.28+ 50
	WHEN	Gender	=	'F'	AND	Age	IN	('16','17')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Separation Anxiety Score'	THEN	((RawScore	- 3.05)*10)/ 2.57+ 50
	WHEN	Gender	=	'F'	AND	Age	IN	('16','17')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Social Phobia Score'	THEN	((RawScore	- 12.85)*10)/ 4.98+ 50
	WHEN	Gender	=	'M'	AND	Age	IN ('8','9')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Depression Score'	THEN	((RawScore	- 3.71)*10)/2.93 + 50
	WHEN	Gender	=	'M'	AND	Age	IN ('8','9')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Generalized Anxiety Score'	THEN	((RawScore	- 4.11)*10)/3.00 + 50
	WHEN	Gender	=	'M'	AND	Age	IN ('8','9')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Obsessions/Compulsions Score'	THEN	((RawScore	- 2.04)*10)/2.43 + 50
	WHEN	Gender	=	'M'	AND	Age	IN ('8','9')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Panic Score'	THEN	((RawScore	- 1.91)*10)/1.90 + 50
	WHEN	Gender	=	'M'	AND	Age	IN ('8','9')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Separation Anxiety Score'	THEN	((RawScore	- 4.29)*10)/3.00 + 50
	WHEN	Gender	=	'M'	AND	Age	IN ('8','9')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Social Phobia Score'	THEN	((RawScore	- 8.44)*10)/3.88 + 50
	WHEN	Gender	=	'F'	AND	Age	IN ('8','9')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Depression RawScore'	THEN	((RawScore	- 3.25)*10)/3.58 + 50
	WHEN	Gender	=	'F'	AND	Age	IN ('8','9')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Generalized Anxiety Score'	THEN	((RawScore	- 4.00)*10)/2.87 + 50
	WHEN	Gender	=	'F'	AND	Age	IN ('8','9')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Obsessions/Compulsions Score'	THEN	((RawScore	- 2.01)*10)/2.63 + 50
	WHEN	Gender	=	'F'	AND	Age	IN ('8','9')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Panic Score'	THEN	((RawScore	- 1.87)*10)/2.61 + 50
	WHEN	Gender	=	'F'	AND	Age	IN ('8','9')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Separation Anxiety Score'	THEN	((RawScore	- 4.20)*10)/3.00 + 50
	WHEN	Gender	=	'F'	AND	Age	IN ('8','9')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Social Phobia Score'	THEN	((RawScore	- 8.01)*10)/3.87 + 50
	WHEN	Gender	=	'M'	AND	Age	IN	('10','11')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Depression Score'	THEN	((RawScore	- 3.62)*10)/2.87 + 50
	WHEN	Gender	=	'M'	AND	Age	IN	('10','11')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Generalized Anxiety Score'	THEN	((RawScore	- 3.74)*10)/2.49 + 50
	WHEN	Gender	=	'M'	AND	Age	IN	('10','11')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Obsessions/Compulsions Score'	THEN	((RawScore	- 2.01)*10)/2.31 + 50
	WHEN	Gender	=	'M'	AND	Age	IN	('10','11')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Panic Score'	THEN	((RawScore	- 1.64)*10)/1.84 + 50
	WHEN	Gender	=	'M'	AND	Age	IN	('10','11')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Separation Anxiety Score'	THEN	((RawScore	- 2.85)*10)/2.79 + 50
	WHEN	Gender	=	'M'	AND	Age	IN	('10','11')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Social Phobia Score'	THEN	((RawScore	- 7.71)*10)/3.94 + 50
	WHEN	Gender	=	'F'	AND	Age	IN	('10','11')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Depression Score'	THEN	((RawScore	- 3.75)*10)/3.63 + 50
	WHEN	Gender	=	'F'	AND	Age	IN	('10','11')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Generalized Anxiety Score'	THEN	((RawScore	- 4.18)*10)/3.18 + 50
	WHEN	Gender	=	'F'	AND	Age	IN	('10','11')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Obsessions/Compulsions Score'	THEN	((RawScore	- 2.03)*10)/2.65 + 50
	WHEN	Gender	=	'F'	AND	Age	IN	('10','11')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Panic Score'	THEN	((RawScore	- 1.79)*10)/2.30 + 50
	WHEN	Gender	=	'F'	AND	Age	IN	('10','11')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Separation Anxiety Score'	THEN	((RawScore	- 3.46)*10)/2.95 + 50
	WHEN	Gender	=	'F'	AND	Age	IN	('10','11')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Social Phobia Score'	THEN	((RawScore	- 8.94)*10)/5.16 + 50
	WHEN	Gender	=	'M'	AND	Age	IN	('12','13')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Depression Score'	THEN	((RawScore	- 3.54)*10)/3.18 + 50
	WHEN	Gender	=	'M'	AND	Age	IN	('12','13')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Generalized Anxiety Score'	THEN	((RawScore	- 3.26)*10)/2.60 + 50
	WHEN	Gender	=	'M'	AND	Age	IN	('12','13')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Obsessions/Compulsions Score'	THEN	((RawScore	- 1.62)*10)/1.98 + 50
	WHEN	Gender	=	'M'	AND	Age	IN	('12','13')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Panic Score'	THEN	((RawScore	- 1.61)*10)/1.56 + 50
	WHEN	Gender	=	'M'	AND	Age	IN	('12','13')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Separation Anxiety Score'	THEN	((RawScore	- 1.97)*10)/2.21 + 50
	WHEN	Gender	=	'M'	AND	Age	IN	('12','13')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Social Phobia Score'	THEN	((RawScore	- 7.59)*10)/4.31 + 50
	WHEN	Gender	=	'F'	AND	Age	IN	('12','13')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Depression Score'	THEN	((RawScore	- 3.6)*10)/3.37 + 50
	WHEN	Gender	=	'F'	AND	Age	IN	('12','13')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Generalized Anxiety Score'	THEN	((RawScore	- 3.23)*10)/2.54 + 50
	WHEN	Gender	=	'F'	AND	Age	IN	('12','13')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Obsessions/Compulsions Score'	THEN	((RawScore	- 1.41)*10)/1.94 + 50
	WHEN	Gender	=	'F'	AND	Age	IN	('12','13')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Panic Score'	THEN	((RawScore	- 1.82)*10)/1.98 + 50
	WHEN	Gender	=	'F'	AND	Age	IN	('12','13')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Separation Anxiety Score'	THEN	((RawScore	- 2.08)*10)/2.33 + 50
	WHEN	Gender	=	'F'	AND	Age	IN	('12','13')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Social Phobia Score'	THEN	((RawScore	- 8.62)*10)/4.65 + 50.
	WHEN	Gender	=	'M'	AND	Age	IN	('14','15')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Depression Score'	THEN	((RawScore	- 5.21)*10)/3.51 + 50
	WHEN	Gender	=	'M'	AND	Age	IN	('14','15')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Generalized Anxiety Score'	THEN	((RawScore	- 3.73)*10)/2.75 + 50
	WHEN	Gender	=	'M'	AND	Age	IN	('14','15')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Obsessions/Compulsions Score'	THEN	((RawScore	- 2.58)*10)/3.03 + 50
	WHEN	Gender	=	'M'	AND	Age	IN	('14','15')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Panic Score'	THEN	((RawScore	- 2.19)*10)/2.34 + 50
	WHEN	Gender	=	'M'	AND Age	IN	('14','15')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Separation Anxiety Score'	THEN	((RawScore	- 1.69)*10)/1.89 + 50
	WHEN	Gender	=	'M'	AND	Age	IN	('14','15')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Social Phobia Score'	THEN	((RawScore	- 8.39)*10)/4.19 + 50
	WHEN	Gender	=	'F'	AND	Age	IN	('14','15')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Depression Score'	THEN	((RawScore	- 3.97)*10)/3.25 + 50
	WHEN	Gender	=	'F'	AND	Age	IN	('14','15')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Generalized Anxiety Score'	THEN	((RawScore	- 3.46)*10)/3.02 + 50
	WHEN	Gender	=	'F'	AND	Age	IN	('14','15')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Obsessions/Compulsions Score'	THEN	((RawScore	- 1.89)*10)/2.57 + 50
	WHEN	Gender	=	'F'	AND	Age	IN	('14','15')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Panic Score'	THEN	((RawScore	- 1.83)*10)/2.13 + 50
	WHEN	Gender	=	'F'	AND	Age	IN	('14','15')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Separation Anxiety Score'	THEN	((RawScore	- 1.91)*10)/2.49 + 50
	WHEN	Gender	=	'F'	AND	Age	IN	('14','15')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Social Phobia Score'	THEN	((RawScore	- 8.83)*10)/4.73 + 50
	WHEN	Gender	=	'M'	AND	Age	IN	('16','17')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Depression Score'	THEN	((RawScore	- 3.94)*10)/3.88 + 50
	WHEN	Gender	=	'M'	AND	Age	IN	('16','17')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Generalized Anxiety Score'	THEN	((RawScore	- 3.22)*10)/2.50 + 50
	WHEN	Gender	=	'M'	AND	Age	IN	('16','17')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Obsessions/Compulsions Score'	THEN	((RawScore	- 1.11)*10)/1.96 + 50
	WHEN	Gender	=	'M'	AND	Age	IN	('16','17')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Panic Score'	THEN	((RawScore	- 1.50)*10)/1.69 + 50
	WHEN	Gender	=	'M'	AND	Age	IN	('16','17')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Separation Anxiety Score'	THEN	((RawScore	- 1.15)*10)/1.55 + 50
	WHEN	Gender	=	'M'	AND	Age	IN	('16','17')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Social Phobia Score'	THEN	((RawScore	- 7.32)*10)/3.69 + 50
	WHEN	Gender	=	'F'	AND	Age	IN	('16','17')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Depression Score'	THEN	((RawScore	- 4.91)*10)/3.17 + 50
	WHEN	Gender	=	'F'	AND	Age	IN	('16','17')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Generalized Anxiety Score'	THEN	((RawScore	- 3.76)*10)/2.28 + 50
	WHEN	Gender	=	'F'	AND	Age	IN	('16','17')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Obsessions/Compulsions Score'	THEN	((RawScore	- 1.8)*10)/2.34 + 50
	WHEN	Gender	=	'F'	AND	Age	IN	('16','17')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Panic Score'	THEN	((RawScore	- 2.04)*10)/2.27 + 50
	WHEN	Gender	=	'F'	AND	Age	IN	('16','17')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Separation Anxiety Score'	THEN	((RawScore	- 1.92)*10)/1.98 + 50
	WHEN	Gender	=	'F'	AND	Age	IN	('16','17')	AND	AssName	=	'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Social Phobia Score'	THEN	((RawScore	- 8.35)*10)/4.38 + 50
	ELSE RawScore
	END as Score
	, CASE 
		WHEN Age = 9 THEN 4
		WHEN Age = 10 THEN 5
		WHEN Age = 11 THEN 6
		WHEN Age = 12 THEN 7
		WHEN Age = 13 THEN 8
		WHEN Age = 14 THEN 9
		WHEN Age = 15 THEN 10
		WHEN Age = 16 THEN 11
		WHEN Age = 17 THEN 12
		ELSE NULL
	END as 'US_school_grade'

INTO #transform
FROM #RefAss a
WHERE a.Der_ValidScore = 'Y' --AND a.Der_UniqAssessment = 'Y'


/*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
PARTITION TO GET OUTCOMES WITHIN THE SAME REFERRAL, WHERE 1st OUTCOME WAS AFTER 1st CONTACT 
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>*/

IF OBJECT_ID ('tempdb..#partitioned_ass') IS NOT NULL
DROP TABLE #partitioned_ass

SELECT * 
	,ROW_NUMBER () OVER (PARTITION BY Person_ID, UniqServReqID, AssName ORDER BY Der_AssToolCompDate ASC, Der_AssUniqID ASC) AS tn
INTO #partitioned_ass
FROM #transform
WHERE Contact1 <= Der_AssToolCompDate --- could remove? 


/*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
GET ALL FINAL OMs (FIRST WILL ALWAYS BE WHERE tn = 1) 
PAIRED OM HAS TO BE ON OR AFTER DATE OF SECOND CONTACT 
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>*/

IF OBJECT_ID ('tempdb..#last_ass') IS NOT NULL
DROP TABLE #last_ass

SELECT 
	a.Person_ID,
	a.UniqServReqID,
	a.AssName,
	MAX(a.tn) AS max_ass

INTO #last_ass

FROM #partitioned_ass a

WHERE a.tn >1 AND a.Der_AssToolCompDate >=a.Contact2 

GROUP BY a.Person_ID,	a.UniqServReqID, a.AssName


/*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
BRING FIRST AND PARIED OM TOGETHER 
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>*/

IF OBJECT_ID ('tempdb..#firstlast_ass') IS NOT NULL
DROP TABLE #firstlast_ass

SELECT  
		r.Person_ID
		,r.UniqServReqID
		,r.RecordNumber
		,r.ServTeamTypeRefToMH
		,r.TeamTypeCat
		,r.Der_FY
		,r.UniqMonthID
		,r.ReportingPeriodStartDate
		,r.Provider_Code 
		,r.Provider_Name
		,r.Provider_Type
		,r.Region_Code --- regions taken from CCG of provider rather than CCG of residence
		,r.Region_Name
		,r.CCGCode
		,r.CCG_Name
		,r.STP_Code
		,r.STP_Name
		,r.STP_Code_prov
		,r.STP_Name_prov
		,r.Region_Code_prov
		,r.Region_Name_prov
		,r.AgeServReferRecDate AS Age
		,r.Gender
		,r.ReferralRequestReceivedDate
		,r.ServDischDate
		,r.ReferClosReason
		,r.RefLength
		,r.AtLeast7days
		,c.TotalContacts
		,c.AttendedContacts
		,c.Contact1
		,c.Contact2
		,a.Der_AssessmentCategory
		,a.Rater
		,a.AssType
		,a.AssName
		,a.Der_AssUniqID AS Der_AssUniqID_first
		,a.Der_AssToolCompDate AS AssDate_first
		,a.Score AS Score_first
		,b.Der_AssUniqID AS Der_AssUniqID_last
		,b.Der_AssToolCompDate AS AssDate_last
		,b.Score AS Score_last
		,b.Score - a.Score AS Change

INTO #firstlast_ass

FROM #ClosedRefs r

LEFT JOIN #Contacts c ON r.UniqServReqID = c.UniqServReqID AND r.Person_ID = c.Person_ID

LEFT JOIN #partitioned_ass a ON r.Person_ID = a.Person_ID AND r.UniqServReqID = a.UniqServReqID AND a.tn = 1 --- join to get first OM 

LEFT JOIN 
	(SELECT x.* FROM #partitioned_ass x INNER JOIN #last_ass y ON x.Person_ID = y.Person_ID AND x.UniqServReqID = y.UniqServReqID AND x.Person_ID = y.Person_ID AND x.AssName = y.AssName AND x.tn = y.max_ass) AS b
ON a.Person_ID = b.Person_ID AND a.UniqServReqID = b.UniqServReqID AND a.AssName = b.AssName

WHERE r.RN = 1 




/*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
BRING IN THRESHOLDS FOR RELIABLE CHANGE (USING NEW METHOD)
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>*/

IF OBJECT_ID ('tempdb..#Change_Thresholds') IS NOT NULL
DROP TABLE #Change_Thresholds

SELECT 
	* 
	,CASE
		WHEN AssName = 'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Depression score' THEN 22.87 ---- CYP IAPT 2015
		WHEN AssName = 'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Generalized Anxiety score' THEN 18.3 ---- CYP IAPT 2015
		WHEN AssName = 'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Obsessions/Compulsions score' THEN 24.06 ---- CYP IAPT 2015
		WHEN AssName = 'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Panic score' THEN 40.93 ---- CYP IAPT 2015
		WHEN AssName = 'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Separation Anxiety score' THEN 28  ---- CYP IAPT 2015
		WHEN AssName = 'RCADS (Revised Childrens Anxiety and Depression Scale) - Parent version - Social Phobia score' THEN 16.63  ---- CYP IAPT 2015
		WHEN AssName = 'SDQ (Strengths and Difficulties Questionnaire) for parents or educators of 4-17 year olds - conduct problems - parent score' THEN ROUND(4.33,0) ---- CYP IAPT 2015
		WHEN AssName = 'SDQ (Strengths and Difficulties Questionnaire) for parents or educators of 4-17 year olds - emotional symptoms - parent score' THEN ROUND(4.39,0)  ---- CYP IAPT 2015
		WHEN AssName = 'SDQ (Strengths and Difficulties Questionnaire) for parents or educators of 4-17 year olds - hyperactivity - parent score' THEN ROUND(3.82,0) ---- CYP IAPT 2015
		WHEN AssName = 'SDQ (Strengths and Difficulties Questionnaire) for parents or educators of 4-17 year olds - impact - parent score' THEN ROUND(3.17,0) ---- CYP IAPT 2015
		WHEN AssName = 'SDQ (Strengths and Difficulties Questionnaire) for parents or educators of 4-17 year olds - peer problems - parent score' THEN ROUND(3.09,0) --- derived from SDQ norms / Goodman (2001) paper
		WHEN AssName = 'SDQ (Strengths and Difficulties Questionnaire) for parents or educators of 4-17 year olds - prosocial - parent score' THEN ROUND(2.62, 0) --- derived from SDQ norms / Goodman (2001) paper
		WHEN AssName = 'Child Outcome Rating Scale total score' THEN 10  ---- CYP IAPT 2015
		WHEN AssName = 'Clinical Outcomes in Routine Evaluation - 10 clinical score' THEN ROUND(5.39,0) ---- CYP IAPT 2015
		WHEN AssName = 'Generalized anxiety disorder 7 item score' THEN ROUND(4.22,0)  ---- CYP IAPT 2015
		WHEN AssName = 'Outcome Rating Scale total score' THEN ROUND(6.55,1)  ---- CYP IAPT 2015
		WHEN AssName = 'Patient health questionnaire 9 score' THEN ROUND(5.99,0)  ---- CYP IAPT 2015
		WHEN AssName = 'RCADS (Revised Childrens Anxiety and Depression Scale) - Depression score' THEN 17.73 ---- CYP IAPT 2015
		WHEN AssName = 'RCADS (Revised Childrens Anxiety and Depression Scale) - Generalized Anxiety score' THEN 14.91 ---- CYP IAPT 2015
		WHEN AssName = 'RCADS (Revised Childrens Anxiety and Depression Scale) - Obsessions/Compulsions score' THEN 16.35 ---- CYP IAPT 2015
		WHEN AssName = 'RCADS (Revised Childrens Anxiety and Depression Scale) - Panic score' THEN 18.29  ---- CYP IAPT 2015
		WHEN AssName = 'RCADS (Revised Childrens Anxiety and Depression Scale) - Separation Anxiety score' THEN 22.95  ---- CYP IAPT 2015
		WHEN AssName = 'RCADS (Revised Childrens Anxiety and Depression Scale) - Social Phobia score' THEN 13.99  ---- CYP IAPT 2015
		WHEN AssName = 'SCORE Index of Family Function and Change - 15 - total score' THEN ROUND(10.2,0) -- from Stratton et al. (2014)
		WHEN AssName = 'SDQ (Strengths and Difficulties Questionnaire) self-rated for 11-17 year olds - conduct problems score' THEN ROUND(3.74,0)  ---- CYP IAPT 2015
		WHEN AssName = 'SDQ (Strengths and Difficulties Questionnaire) self-rated for 11-17 year olds - emotional symptoms score' THEN ROUND(4.26,0)  ---- CYP IAPT 2015
		WHEN AssName = 'SDQ (Strengths and Difficulties Questionnaire) self-rated for 11-17 year olds - hyperactivity score' THEN ROUND(3.87,0)  ---- CYP IAPT 2015
		WHEN AssName = 'SDQ (Strengths and Difficulties Questionnaire) self-rated for 11-17 year olds - impact score' THEN ROUND(3.24, 0)  ---- CYP IAPT 2015
		WHEN AssName = 'SDQ (Strengths and Difficulties Questionnaire) self-rated for 11-17 year olds - peer problems score' THEN ROUND(4.76,0) --- derived from SDQ norms / Goodman (2001) paper 
		WHEN AssName = 'SDQ (Strengths and Difficulties Questionnaire) self-rated for 11-17 year olds - prosocial score' THEN ROUND(4.3,0) --- derived from SDQ norms / Goodman (2001) paper 
		WHEN AssName = 'Young Person''s Clinical Outcomes in Routine Evaluation clinical score' THEN ROUND(8.33,0)  ---- CYP IAPT 2015
		WHEN AssType = 'Goal Based Outcomes (GBO)' THEN 3 
		WHEN AssType IN ('HoNOS-CA (Child and Adolescent)') THEN 2
		WHEN AssType = 'Short Warwick-Edinburgh Mental Well-being Scale (SWEMWBS)' THEN ROUND(2.87,0) --- from Shah et al. (2018)
		WHEN AssType = 'Warwick-Edinburgh Mental Well-being Scale (WEMWBS)' THEN ROUND(8.55,0) --- from Maheswaran et al. (2012) 
		WHEN AssType = 'Childrens Global Assessment Scale (CGAS)' THEN ROUND(10.72,0) --- from Bird et al. (1987)
		ELSE NULL 
		END as MinChange

INTO #Change_Thresholds

FROM #firstlast_ass 


/*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
FLAG RELIABLE CHANGE ACROSS INDIVIDUAL PAIRED SCORES 
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>*/

IF OBJECT_ID ('tempdb..#RCI') IS NOT NULL
DROP TABLE #RCI

SELECT 
* 
,CASE 
		  WHEN AssType NOT IN ('Child Outcome Rating Scale (CORS)', 'Outcome Rating Scale (ORS)', 'Childrens Global Assessment Scale (CGAS)','Goal Based Outcomes (GBO)','Warwick-Edinburgh Mental Well-being Scale (WEMWBS)','Short Warwick-Edinburgh Mental Well-being Scale (SWEMWBS)','SCORE-15 Index of Family Functioning and Change') 
			   AND ABS(change) >= MinChange 
			   AND change < 0 
			   THEN 1
		  WHEN AssType IN ('Child Outcome Rating Scale (CORS)', 'Outcome Rating Scale (ORS)', 'Childrens Global Assessment Scale (CGAS)','Goal Based Outcomes (GBO)','Warwick-Edinburgh Mental Well-being Scale (WEMWBS)','Short Warwick-Edinburgh Mental Well-being Scale (SWEMWBS)','SCORE-15 Index of Family Functioning and Change')
			   AND ABS(change) >= MinChange 
			   AND change > 0 
			   THEN 1
			   ELSE NULL END as [Reliable improvement]
	,CASE WHEN AssType NOT IN ('Child Outcome Rating Scale (CORS)', 'Outcome Rating Scale (ORS)', 'Childrens Global Assessment Scale (CGAS)','Goal Based Outcomes (GBO)','Warwick-Edinburgh Mental Well-being Scale (WEMWBS)','Short Warwick-Edinburgh Mental Well-being Scale (SWEMWBS)','SCORE-15 Index of Family Functioning and Change') 
			   AND ABS(change) >= MinChange 
			   AND change > 0 
			   THEN 1 
		  WHEN AssType IN ('Child Outcome Rating Scale (CORS)', 'Outcome Rating Scale (ORS)', 'Childrens Global Assessment Scale (CGAS)','Goal Based Outcomes (GBO)','Warwick-Edinburgh Mental Well-being Scale (WEMWBS)','Short Warwick-Edinburgh Mental Well-being Scale (SWEMWBS)','SCORE-15 Index of Family Functioning and Change') 
			   AND ABS(change) >= MinChange 
			   AND change < 0 
			   THEN 1
			   ELSE NULL END as [Reliable deterioration]
	,CASE 
		  WHEN ABS(change) < MinChange
			   THEN 1 
			   ELSE NULL END as [No change]

INTO #RCI

FROM #Change_Thresholds


/*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
AGGREGATE RELIABLE CHANGE ACROSS EACH REFERRAL 
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>*/

IF OBJECT_ID ('tempdb..#RCIref') IS NOT NULL
DROP TABLE #RCIref

SELECT
	Person_ID,
	UniqServReqID,
	Rater,
	MAX(Contact1) AS Contact1,
	MAX(Contact2) AS Contact2,
	MAX(CASE WHEN Contact2 IS NOT NULL AND Der_AssUniqID_first IS NOT NULL THEN 1 ELSE NULL END) as Assessment,
	MAX(CASE WHEN Contact2 IS NOT NULL AND Der_AssUniqID_last IS NOT NULL THEN 1 ELSE NULL END) as Paired,
	MAX(CASE WHEN Contact2 IS NOT NULL AND Der_AssUniqID_last IS NOT NULL THEN [Reliable improvement] ELSE NULL END) as Improvement,
	MAX(CASE WHEN Contact2 IS NOT NULL AND Der_AssUniqID_last IS NOT NULL THEN [No change] ELSE NULL END) as NoChange,
	MAX(CASE WHEN Contact2 IS NOT NULL AND Der_AssUniqID_last IS NOT NULL THEN [Reliable deterioration] ELSE NULL END) as Deter

INTO #RCIref

FROM #RCI

WHERE AssName IS NOT NULL 

GROUP BY Person_ID, UniqServReqID, Rater



/*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
CALCULATE OVERALL MEANINGFUL CHANGE ACROSS MULTIPLE MEASURES 
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>*/

IF OBJECT_ID ('tempdb..#MeaningfulChange') IS NOT NULL
DROP TABLE #MeaningfulChange

SELECT 
	Person_ID
	,UniqServReqID
	,Rater
	,Contact1
	,Contact2
	,Assessment
	,Paired 
	,CASE WHEN Improvement = 1 AND Deter IS NULL THEN 1 ELSE 0 END as Improvement 
	,CASE WHEN NoChange = 1 AND Improvement IS NULL AND Deter IS NULL THEN 1 ELSE 0 END as NoChange 
	,CASE WHEN Deter = 1 THEN 1 ELSE 0 END as Deter 

INTO #MeaningfulChange

FROM #RCIref 

/*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
JOIN BACK ON TO REFERRALS (SPLIT BY PERSPECTIVE)
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>*/

IF OBJECT_ID ('tempdb..#Master') IS NOT NULL
DROP TABLE #Master

SELECT 
	r.Person_ID
	,r.UniqServReqID
	,r.RecordNumber
	,r.ServTeamTypeRefToMH
	,r.TeamTypeCat
	,r.Der_FY
	,r.UniqMonthID
	,r.ReportingPeriodStartDate
	,r.Provider_Code
	,r.Provider_Name
	,r.Provider_Type
	,r.Region_Code
	,r.Region_Name
	,r.CCGCode
	,r.CCG_Name
	,r.STP_Code
	,r.STP_Name
	,r.STP_Code_prov
	,r.STP_Name_prov
	,r.Region_Code_prov
	,r.Region_Name_prov
	,r.AgeServReferRecDate AS Age
	,r.Gender
	,r.ReferralRequestReceivedDate
	,r.ServDischDate
	,r.ReferClosReason
	,r.RefLength
	,r.AtLeast7days 
	,c.TotalContacts
	,c.AttendedContacts
	,c.Contact1
	,c.Contact2
	-- self-rated measures 
	,m1.Assessment AS Assessment_SR
	,m1.Paired AS Paired_SR
	,m1.Improvement AS Improvement_SR
	,m1.NoChange AS NoChange_SR
	,m1.Deter AS Deter_SR
	-- parent-rated measures 
	,m2.Assessment AS Assessment_PR
	,m2.Paired AS Paired_PR
	,m2.Improvement AS Improvement_PR
	,m2.NoChange AS NoChange_PR
	,m2.Deter AS Deter_PR
	-- clinician-rated measures
	,m3.Assessment AS Assessment_CR
	,m3.Paired AS Paired_CR
	,m3.Improvement AS Improvement_CR
	,m3.NoChange AS NoChange_CR
	,m3.Deter AS Deter_CR
	,CASE WHEN m1.Assessment = 1 OR m2.Assessment = 1 OR m3.Assessment = 1 THEN 1 ELSE 0 END as Assessment_ANY
	,CASE WHEN m1.Paired = 1 OR m2.Paired = 1 OR m3.Paired = 1 THEN 1 ELSE 0 END as Paired_ANY

INTO #Master

FROM #ClosedRefs r  

LEFT JOIN #Contacts c ON r.UniqServReqID = c.UniqServReqID AND r.Person_ID = c.Person_ID 

LEFT JOIN #MeaningfulChange m1 ON r.UniqServReqID = m1.UniqServReqID AND r.Person_ID = m1.Person_ID AND m1.Rater = 'self' 
LEFT JOIN #MeaningfulChange m2 ON r.UniqServReqID = m2.UniqServReqID AND r.Person_ID = m2.Person_ID AND m2.Rater = 'parent' 
LEFT JOIN #MeaningfulChange m3 ON r.UniqServReqID = m3.UniqServReqID AND r.Person_ID = m3.Person_ID AND m3.Rater = 'clinician' 

WHERE r.RN = 1 


/*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
AGGREGTATE REFERRAL-BASED MEASURES : COMPLETION OF OUTCOMES FOR REFERRALS 
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>*/

IF OBJECT_ID ('tempdb..#AggRef') IS NOT NULL
DROP TABLE #AggRef

SELECT 
	ReportingPeriodStartDate AS MonthYear
	,Der_FY AS FinancialYear 
	,Provider_Code
	,Provider_Name
	,Provider_Type
	,CCGCode
	,CCG_Name
	,STP_Code
	,STP_Name
	,Region_Code
	,Region_Name
	,STP_Code_prov
	,STP_Name_prov
	,Region_Code_prov
	,Region_Name_prov
	--,TeamTypeCat
	--,AtLeast7days
	,COUNT(*) AS Closed_refs 
	,COUNT(*) AS Closed_refs2 --- denom 
	--,SUM(CASE WHEN Contact1 IS NOT NULL THEN 1 ELSE 0 END) as Contact1 
	,SUM(CASE WHEN Contact2 IS NOT NULL THEN 1 ELSE 0 END) as Contact2 
	,SUM(CASE WHEN COntact2 IS NOT NULL THEN 1 ELSE 0 END) as Contact2_2 -- denom 
	-- self-rated mesaures 
	,SUM(ISNULL(Assessment_SR,0)) AS Assessment_SR
	,SUM(ISNULL(Assessment_SR,0)) AS Assessment_SR_2 -- denom
	,SUM(ISNULL(Paired_SR,0)) AS Paired_SR 
	--- parent-rated measures  
	,SUM(ISNULL(Assessment_PR,0)) AS Assessment_PR
	,SUM(ISNULL(Assessment_PR,0)) AS Assessment_PR_2 -- denom 
	,SUM(ISNULL(Paired_PR,0)) AS Paired_PR
	--- clinician-rated mesaures 
	,SUM(ISNULL(Assessment_CR,0)) AS Assessment_CR
	,SUM(ISNULL(Assessment_CR,0)) AS Assessment_CR_2 -- denom  
	,SUM(ISNULL(Paired_CR,0)) AS Paired_CR
	--- ANY measures 
	,SUM(Assessment_ANY) AS Assessment_ANY 
	,SUM(Assessment_ANY) AS Assessment_ANY_2
	,SUM(Paired_ANY) AS Paired_ANY
	--- Contacts and contact DQ 
	,SUM(ISNULL(TotalContacts,0)) AS TotalContacts 
	,SUM(ISNULL(TotalContacts,0)) AS TotalContacts_2 -- denom 
	,SUM(ISNULL(AttendedContacts,0)) AS AttendedContacts
	

INTO #AggRef

FROM #Master m 

GROUP BY ReportingPeriodStartDate, Der_FY, Provider_Code, Provider_Name, Provider_Type, CCGCode, CCG_Name, STP_Code, STP_Name, Region_Code, Region_Name, 
STP_Code_prov, STP_Name_prov, Region_Code_prov, Region_Name_prov
--TeamTypeCat, AtLeast7days




/*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
AGGREGTATE REFERRAL-OUTCOME MEASURES: OVERALL MEANINGFUL CHANGE  
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>*/

IF OBJECT_ID ('tempdb..#AggOMC') IS NOT NULL
DROP TABLE #AggOMC

SELECT 
	r.ReportingPeriodStartDate AS MonthYear
	,r.Der_FY AS FinancialYear 
	,r.Provider_Code
	,r.Provider_Name
	,r.Provider_Type
	,r.CCGCode
	,r.CCG_Name
	,r.STP_Code
	,r.STP_Name
	,r.Region_Code
	,r.Region_Name
	,r.STP_Code_prov
	,r.STP_Name_prov
	,r.Region_Code_prov
	,r.Region_Name_prov
	--,r.TeamTypeCat
	--,r.AtLeast7days
	,m.Rater
	,SUM(m.Assessment) AS Assessment 
	,SUM(m.Assessment) AS Assessment_2 --- Denominator for % paired scores 
	,SUM(ISNULL(m.Paired,0)) AS Paired 
	,SUM(ISNULL(m.Paired,0)) AS Paired_2 --- Denominator for % RC 
	,SUM(m.Improvement) AS Improvement 
	,SUM(m.NoChange) AS NoChange 
	,SUM(m.Deter) AS Deter 

INTO #AggOMC

FROM #ClosedRefs r 

INNER JOIN #MeaningfulChange m ON r.UniqServReqID = m.UniqServReqID AND r.Person_ID = m.Person_ID AND Assessment = 1 

WHERE r.RN = 1 

GROUP BY ReportingPeriodStartDate, Der_FY, Provider_Code, Provider_Name, Provider_Type, CCGCode, CCG_Name, STP_Code, STP_Name, Region_Code, Region_Name, STP_Code_prov, STP_Name_prov, Region_Code_prov, Region_Name_prov, Rater


/*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
AGGREGTATE PAIRED OUTCOME MEASURES - RELIABLE CHANGE 
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>*/

IF OBJECT_ID ('tempdb..#AggPairedMeasures') IS NOT NULL
DROP TABLE #AggPairedMeasures

SELECT
	r.ReportingPeriodStartDate AS MonthYear
	,Der_FY AS FinancialYear 
	,Provider_Code
	,Provider_Name
	,Provider_Type
	,CCGCode
	,CCG_Name
	,STP_Code
	,STP_Name
	,Region_Code
	,Region_Name
	,STP_Code_prov
	,STP_Name_prov
	,Region_Code_prov
	,Region_Name_prov
	--,TeamTypeCat
	--,r.AtLeast7days
	,Rater
	,AssType
	,AssName
	,SUM(CASE WHEN Contact2 IS NOT NULL AND Der_AssUniqID_first IS NOT NULL THEN 1 ELSE 0 END) as Assessment
	,SUM(CASE WHEN Contact2 IS NOT NULL AND Der_AssUniqID_first IS NOT NULL THEN 1 ELSE 0 END) as Assessment_2 -- denom 
	,SUM(CASE WHEN Contact2 IS NOT NULL AND Der_AssUniqID_last IS NOT NULL THEN 1 ELSE 0 END) as Paired 
	,SUM(CASE WHEN Contact2 IS NOT NULL AND Der_AssUniqID_last IS NOT NULL THEN 1 ELSE 0 END) as Paired_2 -- denom 
	,SUM(ISNULL([Reliable improvement],0)) AS Improvement
	,SUM(ISNULL([No change],0)) AS NoChange
	,SUM(ISNULL([Reliable deterioration],0)) AS Deter 

INTO #AggPairedMeasures

FROM #RCI r

WHERE AssName IS NOT NULL 

GROUP BY r.ReportingPeriodStartDate, Der_FY, Provider_Code, Provider_Name, Provider_Type, CCGCode, CCG_Name, STP_Code, STP_Name, Region_Code, Region_Name,
-- TeamTypeCat, 
STP_Code_prov, STP_Name_prov, Region_Code_prov, Region_Name_prov,
Rater, AssType, AssName



/*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
AGGREGTATE OUTCOME MEASURES - COMPLETION
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>*/

IF OBJECT_ID ('tempdb..#AggMeasures') IS NOT NULL
DROP TABLE #AggMeasures

SELECT
	r.ReportingPeriodStartDate AS MonthYear
	,Der_FY AS FinancialYear 
	,Provider_Code
	,Provider_Name
	,Provider_Type
	,CCGCode
	,CCG_Name
	,STP_Code
	,STP_Name
	,Region_Code
	,Region_Name
	,STP_Code_prov
	,STP_Name_prov
	,Region_Code_prov
	,Region_Name_prov
	--,TeamTypeCat
	--,r.AtLeast7days
	,Rater
	,AssType
	,AssName
	,COUNT(*) AS TotalOMs 
	,COUNT(*) as TotalOMs_2 --- denom 
	,SUM(CASE WHEN Der_ValidScore = 'Y' THEN 1 ELSE 0 END) as Val_OMs 
	--,SUM(CASE WHEN Der_UniqAssessment = 'Y' THEN 1 ELSE 0 END) as Unique_OMs 
	,SUM(CASE WHEN Der_AssToolCompDate >= Contact1 THEN 1 ELSE 0 END) as OM_after_Cont1 

INTO #AggMeasures 

FROM #RefAss r 

GROUP BY r.ReportingPeriodStartDate, Der_FY, Provider_Code, Provider_Name, Provider_Type, CCGCode, CCG_Name, STP_Code, STP_Name, Region_Code, Region_Name, Rater, AssType, AssName,
STP_Code_prov, STP_Name_prov, Region_Code_prov, Region_Name_prov




/*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
UNPIVOT AND CREATE EXTRACT
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>*/

IF OBJECT_ID ('tempdb..#Output') IS NOT NULL
DROP TABLE #Output

SELECT 
	'Referral' AS MeasureType 
	,MonthYear 
	,FinancialYear 
	,Provider_Code
	,Provider_Name
	,Provider_Type
	,CCGCode
	,CCG_Name
	,STP_Code
	,STP_Name
	,Region_Code
	,Region_Name
	,STP_Code_prov
	,STP_Name_prov
	,Region_Code_prov
	,Region_Name_prov
	--,TeamTypeCat
	--,AtLeast7days
	,CASE 
		WHEN MeasureName IN ('Assessment_SR','Paired_SR') THEN 'Self'
		WHEN MeasureName IN ('Assessment_PR','Paired_PR') THEN 'Parent' 
		WHEN MeasureName IN ('Assessment_CR','Paired_CR') THEN 'Clinician'
		WHEN MeasureName in ('Assessment_ANY', 'Paired_ANY') THEN 'Any'
	END AS Rater
	,'NA' AS AssType
	,'NA' AS AssName
	,CASE 
		WHEN MeasureName IN ('Assessment_SR','Assessment_PR','Assessment_CR','Assessment_ANY') THEN 'Assessment_ref'
		WHEN MeasureName IN ('Paired_SR','Paired_PR','Paired_CR','Paired_ANY') THEN 'Paired_ref'
	ELSE MeasureName
	END as MeasureName
	,MeasureValue 
	,CASE 
		WHEN MeasureName = 'AttendedContacts' THEN TotalContacts_2 
		WHEN MeasureName = 'Contact2' THEN Closed_refs2 
		WHEN MeasureName IN ('Assessment_SR','Assessment_PR','Assessment_CR','Assessment_ANY') THEN Contact2_2 
		WHEN MeasureName = 'Paired_SR' THEN Assessment_SR_2 --- new denom
		WHEN MeasureName = 'Paired_PR' THEN Assessment_PR_2 --- new denom
		WHEN MeasureName = 'Paired_CR' THEN Assessment_CR_2 --- new denom
		WHEN MeasureName = 'Paired_ANY' THEN Assessment_ANY_2 --- new denom
	END as Denominator 

INTO #Output

FROM #AggRef

UNPIVOT (MeasureValue FOR MeasureName IN 
		(TotalContacts, AttendedContacts, Closed_refs, 
		Contact2,
		Assessment_SR, Paired_SR,
		Assessment_PR, Paired_PR,
		Assessment_CR, Paired_CR,
		Assessment_ANY, Paired_ANY)) u 

UNION ALL 

SELECT 
	'OMC' AS MeasureType 
	,MonthYear 
	,FinancialYear 
	,Provider_Code
	,Provider_Name
	,Provider_Type
	,CCGCode
	,CCG_Name
	,STP_Code
	,STP_Name
	,Region_Code
	,Region_Name
	,STP_Code_prov
	,STP_Name_prov
	,Region_Code_prov
	,Region_Name_prov
	--,TeamTypeCat
	--,AtLeast7days
	,Rater
	,'NA' AS AssType
	,'NA' AS AssName
	,MeasureName
	,MeasureValue
	,CASE 
		WHEN MeasureName = 'Paired' THEN Assessment_2 
		WHEN MeasureName IN ('Improvement','NoChange','Deter') THEN Paired_2 
	END as Denominator 

FROM #AggOMC

UNPIVOT (MeasureValue FOR MeasureName IN 
		(Assessment, Paired, Improvement, NoChange, Deter)) u 


UNION ALL 

SELECT 
	'Paired Measures' AS MeasureType 
	,MonthYear 
	,FinancialYear 
	,Provider_Code
	,Provider_Name
	,Provider_Type
	,CCGCode
	,CCG_Name
	,STP_Code
	,STP_Name
	,Region_Code
	,Region_Name
	,STP_Code_prov
	,STP_Name_prov
	,Region_Code_prov
	,Region_Name_prov
	--,TeamTypeCat
	--,AtLeast7days
	,Rater
	,AssType
	,AssName
	,MeasureName
	,MeasureValue
	,CASE 
		WHEN MeasureName = 'Paired' THEN Assessment_2 
		WHEN MeasureName IN ('Improvement','NoChange','Deter') THEN Paired_2 
	END as Denominator 

FROM #AggPairedMeasures

UNPIVOT (MeasureValue FOR MeasureName IN 
		(Assessment, Paired, Improvement, NoChange, Deter)) u 


UNION ALL 

SELECT 
	'Individual OMs' AS MeasureType 
	,MonthYear 
	,FinancialYear 
	,Provider_Code
	,Provider_Name
	,Provider_Type
	,CCGCode
	,CCG_Name
	,STP_Code
	,STP_Name
	,Region_Code
	,Region_Name
	,STP_Code_prov
	,STP_Name_prov
	,Region_Code_prov
	,Region_Name_prov
	--,TeamTypeCat
	--,AtLeast7days
	,Rater
	,AssType
	,AssName
	,MeasureName
	,MeasureValue
	,CASE WHEN MeasureName IN ('Val_OMs','OM_after_Cont1') THEN TotalOMs_2 END as Denominator 

FROM #AggMeasures

UNPIVOT (MeasureValue FOR MeasureName IN 
		(TotalOMs, Val_OMs, OM_after_Cont1)) u 











--drop table NHSE_Sandbox_MentalHealth.dbo.Dashboard_CYP_Outcomes_v2
--select * 
--into NHSE_Sandbox_MentalHealth.dbo.Dashboard_CYP_Outcomes_v2
--from #Output


